---
title: "2021-01-21_VertNet_Bergmann"
author: "Mallory A. Ballinger"
date: "1/21/2021"
output:
  github_document:
    html_preview: false
editor_options:
  chunk_output_type: console
---
```{r libraries_and_data, message=FALSE, echo=FALSE}
rm(list = ls())
library(tidyverse)
library(here)
library(knitr)
library(lmerTest)
library(lme4)
library(emmeans)
library(stargazer)
```

#### Are there any general patterns of Bergmann's Rule and Allen's Rule in American house mice?
Using metadata of *Mus musculus* downloaded from [VertNet](http://vertnet.org/), we asked if there is any evidence of Bergmann's Rule and Allen's Rule in introduced populations of American house mice.

The dataset was download from VertNet on 2020-10-13 with the following queries:
* vntype:specimen
* genus:Mus

Query records: 62139. Raw data file is located: **/data/raw/VertNet_Mus_specimen_20201013.tsv**

Given the "messy" nature of VertNet data, the first-pass filters were done in the .tsv file itself, outside of R. The following filters were implemented:
* deleted fossil and occurence 'basis of record' (only kept Preserved Specimens)
* deleted the following 'continents': ND, Africa, Asia, Zoo
* deleted all island groups
* deleted all Panama entries that were collected under the 'Panama Hantavirus' expedition
* deleted any entries that had no data
* deleted all entries without latitude or longitude data
* deleted all entries that were 'founders of colonies', as these animals were apart of a lab colony
* deleted all entries described as 'road kill' or 'dead in trap' or 'found dead', as these can skew body mass
* did not include entries that had multiple entries listed for one
* deleted tail lengths that were described as broken or damaged

Next, not all data entries were coded for lifestage (e.g. adult, subadult). Only a handful were, with the large majority being left blank. During formating, I went through and coded lifestage for as many data entries as possible through the following criteria:
* *Females*: if the following reproductive data were provided, I coded the data entry as 'adult'. If not, I left it uncoded.
  * presence of placental scars,
  * characterized as parous,
  * evidence of lactating,
  * pregnant
* *Males*: if the following reproductive data were provided, I coded the data entry as 'adult'. If not, I left in uncoded.
  * scrotal,
  * measurements for seminal vesicles,
  * characterized as TD ("testes descended"),
  * characterized as TS ("testes scrotal")

The processed data file is located: **/data/processed/VertNet_Mus_specimen_20201013_processed.csv**


1. Read in raw data, conduct additional filtering and formating
```{r explore_data, message=FALSE}
# Read in data
VertNetMetaData <- read_csv(here("data/processed/VertNet_Mus_processed.csv"),
                            col_types = cols(.default = col_character(),
                                             totallength_mm = col_double(),
                                             taillength_mm = col_double(),
                                             hindfootlength_mm = col_double(),
                                             earlength_mm = col_double(),
                                             bodyweight_g = col_double(),
                                             bodylength_mm = col_double(),
                                             year = col_double(),
                                             decimallatitude = col_double(),
                                             decimallongitude = col_double(),
                                             lengthinmm = col_double(),
                                             lengthunitsinferred = col_double(),
                                             massing = col_double(),
                                             massunitsinferred = col_double())) %>% # I first used guess_max = Inf to figure out what the column specifications are
  select(references, dynamicproperties, totallength_mm, taillength_mm, hindfootlength_mm, 
         earlength_mm, bodyweight_g, bodylength_mm, sex, lifestage, reproductivecondition,
         continent, country, stateprovince, decimallatitude, decimallongitude) %>%
  filter(continent == "North America" | continent == "South America") %>%
  filter(is.na(lifestage) | lifestage != "subadult") %>% # everything but subadult (including NAs)
  filter(is.na(lifestage) | lifestage != "undetermined") %>% # everything but undetermined (including NAs)
  filter(is.na(reproductivecondition) | reproductivecondition != "preg") %>% # everything but pregnant mice (including NAs)
  filter(sex == "female" | sex == "male") %>% # only males and females
  mutate(abslat = abs(decimallatitude),sex = as.factor(sex), lifestage = as.factor(lifestage)) %>%
  mutate_if(is.factor, fct_explicit_na, na_level = 'NA') %>% # let's you relevel NAs (I think)
  mutate(lifestage = fct_relevel(lifestage, "NA", "adult"))
```

***

### 2. Explore the data - Bergmann's Rule (i.e. body weight)

##### 2a. Plot raw data (residuals) to ensure normally distributed
```{r all_data_Bergmann, message=FALSE}
## Ensure data are normally distributed
hist(VertNetMetaData$bodyweight_g, breaks = 25)
plot(VertNetMetaData$bodyweight_g)
lmBW <- lm(bodyweight_g~abslat, data=VertNetMetaData)
summary(lmBW)
plot(lmBW$residuals)
hist(lmBW$residuals, breaks = 25)
```
Data look normally distributed!

##### 2b. Plot residuals to identify outliers
```{r outliers, message=FALSE}
plot(lmBW)
```

```{r outliers_again, message=FALSE}
temp<-as.data.frame(VertNetMetaData)
row.names(temp)<-temp$references
lmBW2 <- lm(bodyweight_g~abslat, data=temp)
plot(lmBW2) # outliers are labeled with "$references" id
```
From the outlier analysis, it is clear that mice with body weights > 38g are outliers.
To be safe, we'll say anything over 35g since the next largest mouse in 33g. These data points will be removed from subsequent analyses.
It is not as clear which smaller body weights are outliers; therefore, we'll keep all of those in both datasets.


##### 2c. Plot all the data
```{r color, message=FALSE, echo=FALSE}
# Make a new color that's a transparent black - this color will be used to denote the full dataset, while black will be used to denote adults-only dataset
col2rgb("black", alpha = FALSE)
fulldatacol <- rgb(0, 0, 0, max = 255, alpha = 75, names = "blackish")
```

```{r plot_Bergmann, message = FALSE}
VertNetBerg <- VertNetMetaData %>%
  filter(bodyweight_g < 35) # remove outliers

# Plot the data
Berg <-
  ggplot(data=VertNetBerg, aes(x = abslat, y = bodyweight_g)) +
  geom_jitter(aes(color = lifestage), height = 0, width = .2) +
  geom_smooth(data=subset(VertNetBerg, lifestage == "adult"),
             aes(x = abslat, y = bodyweight_g, color=factor(lifestage), fill=factor(lifestage)),
             method = "lm", se = TRUE, alpha = 0.3) + # just draws a line for adults
  scale_color_manual(values=c(fulldatacol, "black")) +
  scale_fill_manual(values=c(fulldatacol, "black")) +
  theme_bw() + 
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
        axis.title.x = element_text(margin = margin(t = 25), size = 18, face = "bold", family = "Palatino"),
        axis.title.y = element_text(margin = margin(r = 25), size = 18, face = "bold", family = "Palatino"),
        axis.text.x = element_text(size = 15, face = "bold", color = "black", family = "Palatino"),
        axis.text.y = element_text(size = 15, face = "bold", color = "black", family = "Palatino")) +
  theme(legend.title = element_blank(),
        legend.position="none",
        legend.key.size = unit(1.5, "cm"),
        legend.text = element_text(size=10),
        legend.key = element_rect(fill = "transparent")) +
  theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5, family = "Palatino")) +
  labs(x = "Absolute Latitude", y = "Body Mass (g)") +
  ggtitle("Bergmann's Rule in American house mice - includes both sexes")
Berg + geom_smooth(method = "lm", se = TRUE, color = fulldatacol, fill=fulldatacol, alpha=0.1) # draws a line for all lifestage data (both NA and adults)

```


##### 2d. Plot sex-specific Bergmann's Rule
```{r sexspecific_berg, message=FALSE}
# Plot sex-specific Bergmann's rule for full dataset
VertNetBerg <- VertNetMetaData %>%
  filter(bodyweight_g < 35) # remove outliers

Berg_Sex <-
  ggplot(data=VertNetBerg, aes(x = abslat, y = bodyweight_g), color = sex) +
  geom_jitter(aes(color = sex), size = 2, height = 0, width = 0.2, alpha = 0.5) +
  geom_smooth(method = "lm", se = TRUE, aes(color = sex, fill = sex), alpha = 0.2) +
  scale_color_manual(values=c("red", "blue")) +
  scale_fill_manual(values=c("red", "blue")) +
  theme_bw() + 
 theme(panel.border = element_rect(color = "black", fill = NA, size = 1),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), #axis.line = element_line(colour = "black"),
        axis.title.x = element_text(margin = margin(t = 25), size = 18, face = "bold", family = "Palatino"),
        axis.title.y = element_text(margin = margin(r = 25), size = 18, face = "bold", family = "Palatino"),
        axis.text.x = element_text(size = 15, face = "bold", color = "black", family = "Palatino"),
        axis.text.y = element_text(size = 15, face = "bold", color = "black", family = "Palatino")) +
  theme(legend.title = element_blank(),
        legend.position = c(0.1, 0.95), legend.box = "horizontal",
        legend.key.size = unit(0.5, "cm"),
        legend.text = element_text(size=10, family = "Palatino"),
        legend.key = element_rect(fill = "transparent")) +
  theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5, family = "Palatino")) +
  labs(x = "Absolute Latitude", y = "Body Mass (g)") +
  ggtitle("Sex-specific Bergmann's Rule for entire dataset")
Berg_Sex
```

```{r more_sex, message=FALSE}
# Plot sex-specific Bergmann's rule for adult-only dataset
VertNetBergAdults <- VertNetMetaData %>%
  filter(bodyweight_g < 35) %>%
  filter(lifestage == "adult")

Berg_Sex_Adults <-
  ggplot(data=VertNetBergAdults, aes(x = abslat, y = bodyweight_g), color = sex) +
  geom_jitter(aes(color = sex), size = 2, height = 0, width = 0.2, alpha = 0.5) +
  geom_smooth(method = "lm", se = TRUE, aes(color=sex, fill=sex), alpha = 0.2) + # se default (TRUE) shows 95% CI
  scale_color_manual(values=c("red", "blue")) +
  scale_fill_manual(values=c("red", "blue")) +
  theme_bw() + 
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), #axis.line = element_line(colour = "black"),
        axis.title.x = element_text(margin = margin(t = 25), size = 18, face = "bold", family = "Palatino"),
        axis.title.y = element_text(margin = margin(r = 25), size = 18, face = "bold", family = "Palatino"),
        axis.text.x = element_text(size = 15, face = "bold", color = "black", family = "Palatino"),
        axis.text.y = element_text(size = 15, face = "bold", color = "black", family = "Palatino")) +
  theme(legend.title = element_blank(),
        legend.position = c(0.1, 0.95), legend.box = "horizontal",
        legend.key.size = unit(0.5, "cm"),
        legend.text = element_text(size=10, family = "Palatino"),
        legend.key = element_rect(fill = "transparent")) +
  theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5, family = "Palatino")) +
  labs(x = "Absolute Latitude", y = "Body Mass (g)") +
  ggtitle("Sex-specific Bergmann's Rule for adults-only dataset")
Berg_Sex_Adults

```


##### 2e. Stats for Bergmann's Rule
```{r Berg_stats, results='asis', message=FALSE}
# Model 1 includes all data, no sex
BergM1 <- lm(bodyweight_g~abslat, data = VertNetBerg)

# Model 2 includes adult-only data, no sex
BergM2 <- lm(bodyweight_g~abslat, data = VertNetBergAdults)

# Model 3 includes all data, with both sexes
BergM3 <- lm(bodyweight_g~abslat*sex, data = VertNetBerg)

# Model 4 includes all data, with only females
VertNetBergF <- VertNetBerg %>%
  filter(sex == "female")
BergM4 <- lm(bodyweight_g~abslat, data = VertNetBergF)

# Model 5 includes all data, with only males
VertNetBergM <- VertNetBerg %>%
  filter(sex == "male")
BergM5 <- lm(bodyweight_g~abslat, data = VertNetBergM)

# Model 6 includes adult-only data, with both sexes
BergM6 <- lm(bodyweight_g~abslat*sex, data = VertNetBergAdults)

# Model 7 includes adult-only data, with only females
VertNetBergAdultsF <- VertNetBergAdults %>%
  filter(sex == "female")
BergM7 <- lm(bodyweight_g~abslat, data = VertNetBergAdultsF)

# Model 8 includes adult-only data, with only males
VertNetBergAdultsM <- VertNetBergAdults %>%
  filter(sex == "male")
BergM8 <- lm(bodyweight_g~abslat, data = VertNetBergAdultsM)


stargazer(BergM1, BergM2,
          title = "Body weight regression table - all data vs. adult-only data",
          label = "tab1",
          table.placement = "H",
          column.labels = c("M1", "M2"),
          model.numbers = FALSE,
          header = FALSE,
          type = "html")

stargazer(BergM3, BergM6,
          title = "Body weight regression table - all data vs. adult-only data, with sex",
          label = "tab2",
          table.placement = "H",
          column.labels = c("M3", "M6"),
          model.numbers = FALSE,
          header = FALSE)

stargazer(BergM4, BergM5, BergM7, BergM8,
          title = "Body weight regression table - all data vs. adult-only data, with sexes separated out",
          label = "tab3",
          table.placement = "H",
          column.labels = c("M4", "M5", "M7", "M8"),
          model.numbers = FALSE,
          header = FALSE)
```

And here are the tables to see?: Table 1 `r "tab1"`, Table 2 `r "tab2"`, and Table 3 `r "tab3"`.