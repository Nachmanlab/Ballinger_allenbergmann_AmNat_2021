---
title: "Bergmann's Rule and Allen's Rule in Nachman Lab latitudinal transects"
author: "Mallory A. Ballinger"
date: "2/15/2021"
output: 
  github_document:
    html_preview: false
editor_options: 
  chunk_output_type: console
---
```{r libraries_and_data, message=FALSE, echo=FALSE}
rm(list = ls()) # clears R's "memory"
library(tidyverse)
library(here)
library(cowplot)

# Read in and format data
NachmanTransectsMetadata <- read_csv(here("data/raw/NachmanLab_MusTransects_Metadata_2021-02-15.csv")) %>%
  select(GUID, COLLECTORS, CONTINENT_OCEAN, COUNTRY, STATE_PROV, YEAR_COLLECTED, DEC_LAT, DEC_LONG, AGE_CLASS,
         EAR_FROM_NOTCH, HIND_FOOT_WITH_CLAW, REPRODUCTIVE_DATA_2, SEX, TAIL_LENGTH, TOTAL_LENGTH, WEIGHT) %>%
  filter(is.na(AGE_CLASS) | AGE_CLASS != "juvenile") %>% # everything but juvenile (including NAs)
  filter(is.na(AGE_CLASS) | AGE_CLASS != "subadult") %>% # everything but subadult (including NAs)
  filter(is.na(REPRODUCTIVE_DATA_2) | REPRODUCTIVE_DATA_2 != "pregnant") %>% # everything but pregnant mice (including NAs)
  mutate(ABS_LAT = abs(DEC_LAT), AGE_CLASS = as.factor(AGE_CLASS)) %>%
  mutate(BODY_LENGTH = TOTAL_LENGTH - TAIL_LENGTH) %>% # don't make BL as a factor or else the "NAs" will be treated as a factor (duh)
  #mutate(AGE_CLASS = fct_relevel(AGE_CLASS, "NA", "adult")) %>%
  mutate_if(is.factor, fct_explicit_na, na_level = 'NA') # let's you relevel NAs (I think)

```

```{r Bergmann_BW_RawData, message=FALSE, echo=FALSE, fig.show='hide'}
## Ensure data are normally distributed
hist(NachmanTransectsMetadata$WEIGHT, breaks = 25)
plot(NachmanTransectsMetadata$WEIGHT)
lmBW <- lm(WEIGHT~ABS_LAT, data=NachmanTransectsMetadata)
summary(lmBW)
plot(lmBW$residuals) # plotting residuals tells you if data are normally distributed
hist(lmBW$residuals, breaks = 25)

# Outlier test on full data
out_BW_full<-boxplot.stats(NachmanTransectsMetadata$WEIGHT)$out
out_BW_full
corrBW <- cor.test(x = NachmanTransectsMetadata$ABS_LAT, y = NachmanTransectsMetadata$WEIGHT, method = 'spearman')
corrBW

# No clear outliers we need to worry about

```

## Plot Bergmann's rule: body mass by absolute latitude

```{r Bergmann_plot, message=FALSE}
Berg<-
  ggplot(data=NachmanTransectsMetadata, aes(x = ABS_LAT, y = WEIGHT)) +
  geom_smooth(color = "gray", fill = "gray", linetype = "solid", method = "lm", se = FALSE) + # se default (TRUE) shows 95% CI
  geom_jitter(size = 2.2, height = 0, width = 0.2, alpha = 0.7) +
  theme_bw() + 
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), #axis.line = element_line(colour = "black"),
        axis.title.x = element_text(margin = margin(t = 25), size = 18, face = "bold", family = "Palatino"),
        axis.title.y = element_text(margin = margin(r = 25), size = 18, face = "bold", family = "Palatino"),
        axis.text.x = element_text(size = 15, face = "bold", color = "black", family = "Palatino"),
        axis.text.y = element_text(size = 15, face = "bold", color = "black", family = "Palatino")) +
  theme(legend.title = element_blank(),
        legend.position = c(0.1, 0.95), legend.box = "horizontal",
        legend.key.size = unit(0.5, "cm"),
        legend.text = element_text(size=10, family = "Palatino"),
        legend.key = element_rect(fill = "transparent")) +
  theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5, family = "Palatino")) +
  labs(x = "Degrees from the equator", y = "Body Mass (g)")
Berg
```

```{r Bergmann_sex, message=FALSE}
# Plot sex-specific Bergmann's rule

Berg_Sex <-
  ggplot(data=NachmanTransectsMetadata, aes(x = ABS_LAT, y = WEIGHT), color = SEX) +
  geom_jitter(aes(color = SEX), size = 2, height = 0, width = 0.2, alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE, aes(color=SEX, fill=SEX), alpha = 0.2, linetype = "dashed") + # se default (TRUE) shows 95% CI
  scale_color_manual(values=c("red", "blue")) +
  scale_fill_manual(values=c("red", "blue")) +
  theme_bw() + 
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), #axis.line = element_line(colour = "black"),
        axis.title.x = element_text(margin = margin(t = 25), size = 18, face = "bold", family = "Palatino"),
        axis.title.y = element_text(margin = margin(r = 25), size = 18, face = "bold", family = "Palatino"),
        axis.text.x = element_text(size = 15, face = "bold", color = "black", family = "Palatino"),
        axis.text.y = element_text(size = 15, face = "bold", color = "black", family = "Palatino")) +
  theme(legend.title = element_blank(),
        legend.position = c(0.1, 0.95), legend.box = "horizontal",
        legend.key.size = unit(0.5, "cm"),
        legend.text = element_text(size=10, family = "Palatino"),
        legend.key = element_rect(fill = "transparent")) +
  theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5, family = "Palatino")) +
  labs(x = "Absolute Latitude", y = "Body Mass (g)") +
  ggtitle("Sex-specific Bergmann's Rule")
Berg_Sex

```

#### Strong and clear evidence for Bergmann's rule in wild-caught "Nachman Lab" house mice across the Americas



```{r Allen_TL_RawData, message=FALSE, fig.show='hide'}
#### check data to ensure they are normally distributed
#hist(NachmanTransectsMetadata$TAIL_LENGTH, breaks = 25)
# lmTL <- lm(TAIL_LENGTH~ABS_LAT, data=NachmanTransectsMetadata)
# summary(lmTL)
# plot(lmTL$residuals) # residuals will tell you if your data are normally distributed or not
# hist(lmTL$residuals, breaks = 25) # looks normally distributed!

# any tail less than 40mm is an outlier (looks like there's one tail length that's < 20mm)
# 
# #### check for outliers ####
# plot(NachmanTransectsMetadata$TAIL_LENGTH~NachmanTransectsMetadata$ABS_LAT)
# abline(40,0, col="red")
# abline(120,0, col="red")
# 
# tempTL<-as.data.frame(lmTL$residuals)
# tempTL<-tempTL[order(tempTL$`lmTL$residuals`),] # puts residuals in order from small->large
# plot(tempTL)
# 
# 
# # tails shorter than 40mm are *clear* outliers
# 
# # Outlier test on full data
# out_tail_full<-boxplot.stats(NachmanTransectsMetadata$TAIL_LENGTH)$out
# out_tail_full
# plot(NachmanTransectsMetadata$taillength_mm)
# abline(25,0, col="red") #sample points are in order (index)
# abline(120,0, col="red")

```

```{r TailResiduals, message = FALSE, fig.show='hide'}
### Get BW-corrected residuals of tail length
Nachman_TailData <- NachmanTransectsMetadata %>%
  filter(TAIL_LENGTH > 20)

plot(Nachman_TailData$TAIL_LENGTH~Nachman_TailData$ABS_LAT)
plot(Nachman_TailData$TAIL_LENGTH~Nachman_TailData$WEIGHT) # larger mice, generally, have longer tails
lmTLBW <- lm(TAIL_LENGTH~WEIGHT, data=Nachman_TailData)
summary(lmTLBW)
plot(lmTLBW$residuals)
hist(lmTLBW$residuals, breaks = 25)
resTLBW <- resid(lmTLBW) # save residuals so can plot them later
plot(cooks.distance(lmTLBW), pch = 16, col = "blue") # see if any weird outliers
cooksTLBW <- cooks.distance(lmTLBW)
# Plot the Cook's Distance using the traditional 4/n criterion
sample_size <- nrow(Nachman_TailData)
plot(cooksTLBW, pch="*", cex=2, main="Influential Obs by Cooks distance")  # plot cook's distance
abline(h = 4/sample_size, col="red")  # add cutoff line
text(x=1:length(cooksTLBW)+1, y=cooksTLBW, labels=ifelse(cooksTLBW>4/sample_size, names(cooksTLBW),""), col="red")  # add labels

Nachman_TailData$Resids_TLBW <- resid(lmTLBW) # saves residuals to Nachman_TailData dataset (the dataset used to create lm and residuals)

tempTLBW<-as.data.frame(lmTLBW$residuals)
tempTLBW<-tempTLBW[order(tempTLBW$`lmTLBW$residuals`),] # puts residuals in order from small->large
plot(tempTLBW) # in order
#plot(resTLBW) # not in order


plot(Nachman_TailData$ABS_LAT, resTLBW)
# or
plot(Resids_TLBW~ABS_LAT, data = Nachman_TailData)
```

## Plot Allen's rule: Tail length residuals by absolute latitude

```{r Allen_plot, message=FALSE}
Tail_Allen <-
  ggplot(data=Nachman_TailData, aes(x = ABS_LAT, y = Resids_TLBW)) +
  geom_smooth(color = "gray", fill = "gray", linetype = "solid", method = "lm", se = FALSE) + # se default (TRUE) shows 95% CI
  geom_jitter(size = 2.2, height = 0, width = 0.2, alpha = 0.7) +
  theme_bw() + 
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), #axis.line = element_line(colour = "black"),
        axis.title.x = element_text(margin = margin(t = 25), size = 18, face = "bold", family = "Palatino"),
        axis.title.y = element_text(margin = margin(r = 25), size = 18, face = "bold", family = "Palatino"),
        axis.text.x = element_text(size = 15, face = "bold", color = "black", family = "Palatino"),
        axis.text.y = element_text(size = 15, face = "bold", color = "black", family = "Palatino")) +
  theme(legend.title = element_blank(),
        legend.position = c(0.1, 0.95), legend.box = "horizontal",
        legend.key.size = unit(0.5, "cm"),
        legend.text = element_text(size=10, family = "Palatino"),
        legend.key = element_rect(fill = "transparent")) +
  theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5, family = "Palatino")) +
  labs(x = "Degrees from the equator", y = "Residuals of Tail Length")
Tail_Allen
```

####  Unlike Bergmann's rule, there is no clear evidence for Allen's rule (i.e. tail length) in wild-caught "Nachman Lab" house mice across the Americas

## Some stats

```{r stats, message=FALSE}
## Bergmann
corrBW <- cor.test(x = NachmanTransectsMetadata$ABS_LAT, y = NachmanTransectsMetadata$WEIGHT, method = 'spearman') # correlation
corrBW
lmBW <- lm(WEIGHT~ABS_LAT, data=NachmanTransectsMetadata) # linear regression
summary(lmBW)


## Allen
corrTLBW <- cor.test(x = Nachman_TailData$ABS_LAT, y = Nachman_TailData$Resids_TLBW, method = 'spearman') # correlation
corrTLBW
lm_resTLBW <- lm(Resids_TLBW~ABS_LAT, data = Nachman_TailData) # linear regression
summary(lm_resTLBW)
```




```{r absoluteTL_absoluteLAT, message=FALSE, echo=FALSE, fig.show='hide'}
Tail<-
  ggplot(data=NachmanTransectsMetadata, aes(x = ABS_LAT, y = TAIL_LENGTH)) +
  geom_jitter(size = 2, height = 0, width = 0.2, alpha = 0.5) +
  geom_smooth(method = "lm", se = TRUE, alpha = 0.2) + # se default (TRUE) shows 95% CI
  theme_bw() + 
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), #axis.line = element_line(colour = "black"),
        axis.title.x = element_text(margin = margin(t = 25), size = 18, face = "bold", family = "Palatino"),
        axis.title.y = element_text(margin = margin(r = 25), size = 18, face = "bold", family = "Palatino"),
        axis.text.x = element_text(size = 15, face = "bold", color = "black", family = "Palatino"),
        axis.text.y = element_text(size = 15, face = "bold", color = "black", family = "Palatino")) +
  theme(legend.title = element_blank(),
        legend.position = c(0.1, 0.95), legend.box = "horizontal",
        legend.key.size = unit(0.5, "cm"),
        legend.text = element_text(size=10, family = "Palatino"),
        legend.key = element_rect(fill = "transparent")) +
  theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5, family = "Palatino")) +
  labs(x = "Absolute Latitude", y = "Tail Length (mm)")
Tail
```

```{r all_data_bodylength, message=FALSE, fig.show='hide'}
#### check data to ensure they are normally distributed ####
hist(NachmanTransectsMetadata$BODY_LENGTH, breaks = 25)
lmBL <- lm(BODY_LENGTH~ABS_LAT, data=NachmanTransectsMetadata)
summary(lmBL)
plot(lmBL$residuals)
hist(lmBL$residuals, breaks = 25) # looks normally distributed!

#### check for outliers ####
plot(NachmanTransectsMetadata$BODY_LENGTH~NachmanTransectsMetadata$ABS_LAT)
abline(40,0, col="red")
abline(120,0, col="red")

tempBL<-as.data.frame(lmBL$residuals)
tempBL<-tempBL[order(tempBL$`lmBL$residuals`),] # puts residuals in order from small->large
plot(tempBL)


# body lengths below 63 seem like outliers

# Outlier test on full data
out_BL_full<-boxplot.stats(NachmanTransectsMetadata$BODY_LENGTH)$out
out_BL_full
plot(NachmanTransectsMetadata$BODY_LENGTH)
abline(60,0, col="red") #sample points are in order (index)
abline(120,0, col="red")

# body lengths below 63 are beyond the -20 residuals (perhaps remove them? There are 3 samples....Seems like for sure remove the body length of 60mm)
```

##### How correlated are Body Weight and Body Length?
```{r BW~bodylength, message=FALSE}
plot(NachmanTransectsMetadata$WEIGHT~NachmanTransectsMetadata$BODY_LENGTH) # seems like some longer body lengths have smaller body weights, "skewing" the correlation
```