---
title: "VertNet metadata"
author: "Mallory A. Ballinger"
date: "01/05/2021"
output:
  github_document:
    html_preview: false
editor_options:
  chunk_output_type: console
---
```{r libraries_and_data, message=FALSE, echo=FALSE}
rm(list = ls())
library(tidyverse)
library(here)
library(knitr)
library(lmerTest)
library(lme4)
library(emmeans)
library(stargazer)
```

#### Are there any general patterns of Bergmann's Rule and Allen's Rule in American house mice?
Using metadata of *Mus musculus* downloaded from [VertNet](http://vertnet.org/), we asked if there is any evidence of Bergmann's Rule and Allen's Rule in introduced populations of American house mice.

The dataset was download from VertNet on 2020-10-13 with the following queries:
* vntype:specimen
* genus:Mus

Query records: 62139. Raw data file is located: **/data/raw/VertNet_Mus_specimen_20201013.tsv**

Given the "messy" nature of VertNet data, the first-pass filters were done in the .tsv file itself, outside of R. The following filters were implemented:
* deleted fossil and occurence 'basis of record' (only kept Preserved Specimens)
* deleted the following 'continents': ND, Africa, Asia, Zoo
* deleted all island groups
* deleted all Panama entries that were collected under the 'Panama Hantavirus' expedition
* deleted any entries that had no data
* deleted all entries without latitude or longitude data
* deleted all entries that were 'founders of colonies', as these animals were apart of a lab colony
* deleted all entries described as 'road kill' or 'dead in trap' or 'found dead', as these can skew body mass
* did not include entries that had multiple entries listed for one
* deleted tail lengths that were described as broken or damaged

Next, not all data entries were coded for lifestage (e.g. adult, subadult). Only a handful were, with the large majority being left blank. During formating, I went through and coded lifestage for as many data entries as possible through the following criteria:
* *Females*: if the following reproductive data were provided, I coded the data entry as 'adult'. If not, I left it uncoded.
  * presence of placental scars,
  * characterized as parous,
  * evidence of lactating,
  * pregnant
* *Males*: if the following reproductive data were provided, I coded the data entry as 'adult'. If not, I left in uncoded.
  * scrotal,
  * measurements for seminal vesicles,
  * characterized as TD ("testes descended"),
  * characterized as TS ("testes scrotal")

The processed data file is located: **/data/processed/VertNet_Mus_specimen_20201013_processed.csv**


1. Read in raw data, conduct additional filtering and formating
```{r explore_data, message=FALSE}
# Read in data
VertNetMetaData <- read_csv(here("data/processed/VertNet_Mus_processed.csv"),
                            col_types = cols(.default = col_character(),
                                             totallength_mm = col_double(),
                                             taillength_mm = col_double(),
                                             hindfootlength_mm = col_double(),
                                             earlength_mm = col_double(),
                                             bodyweight_g = col_double(),
                                             bodylength_mm = col_double(),
                                             year = col_double(),
                                             decimallatitude = col_double(),
                                             decimallongitude = col_double(),
                                             lengthinmm = col_double(),
                                             lengthunitsinferred = col_double(),
                                             massing = col_double(),
                                             massunitsinferred = col_double())) %>% # I first used guess_max = Inf to figure out what the column specifications are
  select(references, dynamicproperties, totallength_mm, taillength_mm, hindfootlength_mm, 
         earlength_mm, bodyweight_g, bodylength_mm, sex, lifestage, reproductivecondition,
         continent, country, stateprovince, decimallatitude, decimallongitude) %>%
  filter(continent == "North America" | continent == "South America") %>%
  filter(is.na(lifestage) | lifestage != "subadult") %>% # everything but subadult (including NAs)
  filter(is.na(lifestage) | lifestage != "undetermined") %>% # everything but undetermined (including NAs)
  filter(is.na(reproductivecondition) | reproductivecondition != "preg") %>% # everything but pregnant mice (including NAs)
  filter(sex == "female" | sex == "male") %>% # only males and females
  mutate(abslat = abs(decimallatitude),sex = as.factor(sex), lifestage = as.factor(lifestage)) %>%
  mutate_if(is.factor, fct_explicit_na, na_level = 'NA') %>% # let's you relevel NAs (I think)
  mutate(lifestage = fct_relevel(lifestage, "NA", "adult"))


# Clean data of any weird spaces, etc.
#VertNetMetaData[] <- lapply(VertNetMetaData, function(x) if(is.factor(x)) factor(x) else x)

# Look at the structure of the dataset (to make sure everything was mutated and filtered correclty)
#str(VertNetMetaData)

# Sample sizes of full dataset (lifestage = NAs and adults) and adult dataset (lifestage = adults)
#FullData <- VertNetMetaData %>% summarize(N=n_distinct(references)) %>% pull(N)
#AdultData <- VertNetMetaData %>% filter(lifestage == "adult") %>% summarize(N=n_distinct(references)) %>% pull(N)
```

***

### 2. Explore the data - Bergmann's Rule (i.e. body weight)

##### 2a. Plot raw data to ensure normally distributed and to detect outliers
```{r all_data_Bergmann, message=FALSE}
## Ensure data are normally distributed
hist(VertNetMetaData$bodyweight_g, breaks = 25)
plot(VertNetMetaData$bodyweight_g)
lmBW <- lm(bodyweight_g~abslat, data=VertNetMetaData)
summary(lmBW)
plot(lmBW$residuals)
hist(lmBW$residuals, breaks = 25) # plotting residuals "tells" you how well your model assumptions are - look normally dist.!

## Look for outliers by plotting residuals and via cooks.distance
plot(lmBW) # outliers are labeled by let's double check the sample id
# change row names to ensure IDing correct outlier
temp<-as.data.frame(VertNetMetaData)
row.names(temp)<-temp$references
lmBW.2 <- lm(bodyweight_g~abslat, data=temp)
plot(lmBW.2) # outliers are labeled with "$references" id

# from the outlier analysis, it is clear that mice with body weights > 38g are outliers. To be safe, we'll say anything over 35g since the next largest mouse in 33g

# plot(VertNetMetaData$bodyweight_g~VertNetMetaData$abslat)
# abline(5,0, col="red")
# abline(35,0, col="red")
# # body weights greater than 35 look like clear outliers. Not as clear, to me, which lower body masses are outliers
# 
# # "offical" outlier test on full data to make sure that weights >35g are outliers
# out_berg_full<-boxplot.stats(VertNetMetaData$bodyweight_g)$out
# out_berg_full
# plot(VertNetMetaData$bodyweight_g)
# abline(5,0, col="red")
# abline(35,0, col="red")
# 
# 
# # Let's see if these outliers are also outliers in the adult-only dataset
# AdultVertNet <- VertNetMetaData %>%
#   filter(lifestage == "adult")
# 
# hist(AdultVertNet$bodyweight_g, breaks = 25)
# plot(AdultVertNet$bodyweight_g)
# lmBWadults <- lm(bodyweight_g~abslat, data=AdultVertNet)
# summary(lmBWadults)
# #plot(cooks.distance(lmBWadults), pch = 16, col = "blue") # see if there any weird outliers
# plot(lmBWadults$residuals)
# hist(lmBWadults$residuals, breaks = 25)
# plot(AdultVertNet$bodyweight_g~AdultVertNet$abslat)
# abline(5,0, col="red")
# abline(35,0, col="red")
# #dotchart(AdultVertNet$bodyweight_g, color = AdultVertNet$sex)
# #AdultVertNet[order(AdultVertNet$bodyweight_g),]
# #plot(AdultVertNet$bodyweight_g)
# 
# # anything over 35g is a clear outlier. no adult mouse is below 7g
# 
# # "offical" outlier test on adult dataset
# out_berg_adult<-boxplot.stats(AdultVertNet$bodyweight_g)$out
# out_berg_adult
# plot(AdultVertNet$bodyweight_g)
# abline(5,0, col="red") #sample points are in order (index)
# abline(35,0, col="red")
```
From the above data exploration (in both full and adult-only datasets), it is clear that any mouse with a body weight of 35g or more is an outlier. These data points will be removed from subsequent analyses. It is not as clear which smaller body weights are outliers; therefore, we'll keep all of those in both datasets.


##### 2b. Plot all the data
```{r plot_Bergmann, message = FALSE}
VertNetBerg <- VertNetMetaData %>%
  filter(bodyweight_g < 35) # remove outliers

# Make a new color that's a transparent black - this color will be used to denote the full dataset, while black will be used to denote adults-only dataset
col2rgb("black", alpha = FALSE)
fulldatacol <- rgb(0, 0, 0, max = 255, alpha = 75, names = "blackish")

# Plot the data
Berg <-
  ggplot(data=VertNetBerg, aes(x = abslat, y = bodyweight_g)) +
  geom_jitter(aes(color = lifestage), height = 0, width = .2) +
  geom_smooth(data=subset(VertNetBerg, lifestage == "adult"),
             aes(x = abslat, y = bodyweight_g, color=factor(lifestage), fill=factor(lifestage)),
             method = "lm", se = TRUE, alpha = 0.3) + # just draws a line for adults
  scale_color_manual(values=c(fulldatacol, "black")) +
  scale_fill_manual(values=c(fulldatacol, "black")) +
  theme_bw() + 
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
        axis.title.x = element_text(margin = margin(t = 25), size = 18, face = "bold", family = "Palatino"),
        axis.title.y = element_text(margin = margin(r = 25), size = 18, face = "bold", family = "Palatino"),
        axis.text.x = element_text(size = 15, face = "bold", color = "black", family = "Palatino"),
        axis.text.y = element_text(size = 15, face = "bold", color = "black", family = "Palatino")) +
  theme(legend.title = element_blank(),
        legend.position="none",
        legend.key.size = unit(1.5, "cm"),
        legend.text = element_text(size=10),
        legend.key = element_rect(fill = "transparent")) +
  theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5, family = "Palatino")) +
  labs(x = "Absolute Latitude", y = "Body Mass (g)") +
  ggtitle("Bergmann's Rule in American house mice - includes both sexes")
Berg + geom_smooth(method = "lm", se = TRUE, color = fulldatacol, fill=fulldatacol, alpha=0.1) # draws a line for all lifestage data (both NA and adults)

```


##### 2c. Plot sex-specific Bergmann's Rule
```{r sexspecific_berg, message=FALSE}
# Plot sex-specific Bergmann's rule for full dataset
VertNetBerg <- VertNetMetaData %>%
  filter(bodyweight_g < 35) # remove outliers

Berg_Sex <-
  ggplot(data=VertNetBerg, aes(x = abslat, y = bodyweight_g), color = sex) +
  geom_jitter(aes(color = sex), size = 2, height = 0, width = 0.2, alpha = 0.5) +
  geom_smooth(method = "lm", se = TRUE, aes(color = sex, fill = sex), alpha = 0.2) +
  scale_color_manual(values=c("red", "blue")) +
  scale_fill_manual(values=c("red", "blue")) +
  theme_bw() + 
 theme(panel.border = element_rect(color = "black", fill = NA, size = 1),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), #axis.line = element_line(colour = "black"),
        axis.title.x = element_text(margin = margin(t = 25), size = 18, face = "bold", family = "Palatino"),
        axis.title.y = element_text(margin = margin(r = 25), size = 18, face = "bold", family = "Palatino"),
        axis.text.x = element_text(size = 15, face = "bold", color = "black", family = "Palatino"),
        axis.text.y = element_text(size = 15, face = "bold", color = "black", family = "Palatino")) +
  theme(legend.title = element_blank(),
        legend.position = c(0.1, 0.95), legend.box = "horizontal",
        legend.key.size = unit(0.5, "cm"),
        legend.text = element_text(size=10, family = "Palatino"),
        legend.key = element_rect(fill = "transparent")) +
  theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5, family = "Palatino")) +
  labs(x = "Absolute Latitude", y = "Body Mass (g)") +
  ggtitle("Sex-specific Bergmann's Rule for entire dataset")
Berg_Sex

# Plot sex-specific Bergmann's rule for adult-only dataset
VertNetBergAdults <- AdultVertNet %>%
  filter(bodyweight_g < 35)

Berg_Sex_Adults <-
  ggplot(data=VertNetBergAdults, aes(x = abslat, y = bodyweight_g), color = sex) +
  geom_jitter(aes(color = sex), size = 2, height = 0, width = 0.2, alpha = 0.5) +
  geom_smooth(method = "lm", se = TRUE, aes(color=sex, fill=sex), alpha = 0.2) + # se default (TRUE) shows 95% CI
  scale_color_manual(values=c("red", "blue")) +
  scale_fill_manual(values=c("red", "blue")) +
  theme_bw() + 
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), #axis.line = element_line(colour = "black"),
        axis.title.x = element_text(margin = margin(t = 25), size = 18, face = "bold", family = "Palatino"),
        axis.title.y = element_text(margin = margin(r = 25), size = 18, face = "bold", family = "Palatino"),
        axis.text.x = element_text(size = 15, face = "bold", color = "black", family = "Palatino"),
        axis.text.y = element_text(size = 15, face = "bold", color = "black", family = "Palatino")) +
  theme(legend.title = element_blank(),
        legend.position = c(0.1, 0.95), legend.box = "horizontal",
        legend.key.size = unit(0.5, "cm"),
        legend.text = element_text(size=10, family = "Palatino"),
        legend.key = element_rect(fill = "transparent")) +
  theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5, family = "Palatino")) +
  labs(x = "Absolute Latitude", y = "Body Mass (g)") +
  ggtitle("Sex-specific Bergmann's Rule for adults-only dataset")
Berg_Sex_Adults

```


##### 2d. Stats for Bergmann's Rule
```{r Berg_stats, message=FALSE}
# Model 1 includes all data, no sex
BergM1 <- lm(bodyweight_g~abslat, data = VertNetBerg)

# Model 2 includes adult-only data, no sex
BergM2 <- lm(bodyweight_g~abslat, data = VertNetBergAdults)

# Model 3 includes all data, with both sexes
BergM3 <- lm(bodyweight_g~abslat*sex, data = VertNetBerg)

# Model 4 includes all data, with only females
VertNetBergF <- VertNetBerg %>%
  filter(sex == "female")
BergM4 <- lm(bodyweight_g~abslat, data = VertNetBergF)

# Model 5 includes all data, with only males
VertNetBergM <- VertNetBerg %>%
  filter(sex == "male")
BergM5 <- lm(bodyweight_g~abslat, data = VertNetBergM)

# Model 6 includes adult-only data, with both sexes
BergM6 <- lm(bodyweight_g~abslat*sex, data = VertNetBergAdults)

# Model 7 includes adult-only data, with only females
VertNetBergAdultsF <- VertNetBergAdults %>%
  filter(sex == "female")
BergM7 <- lm(bodyweight_g~abslat, data = VertNetBergAdultsF)

# Model 8 includes adult-only data, with only males
VertNetBergAdultsM <- VertNetBergAdults %>%
  filter(sex == "male")
BergM8 <- lm(bodyweight_g~abslat, data = VertNetBergAdultsM)


stargazer(BergM1, BergM2,
          title = "Body weight regression table - all data vs. adult-only data",
          label = "tab1",
          table.placement = "H",
          column.labels = c("M1", "M2"),
          model.numbers = FALSE,
          header = FALSE)

stargazer(BergM3, BergM6,
          title = "Body weight regression table - all data vs. adult-only data, with sex",
          label = "tab2",
          table.placement = "H",
          column.labels = c("M3", "M6"),
          model.numbers = FALSE,
          header = FALSE)

stargazer(BergM4, BergM5, BergM7, BergM8,
          title = "Body weight regression table - all data vs. adult-only data, with sexes separated out",
          label = "tab3",
          table.placement = "H",
          column.labels = c("M4", "M5", "M7", "M8"),
          model.numbers = FALSE,
          header = FALSE)
```


***

### 3. Explore the data - Allen's Rule (i.e. tail length and ear length)

##### 3a. Plot raw body length data to find outliers
```{r all_data_BodyLength, message=FALSE, fig.show='hide'}
# To 'correct' for body size in regards to extremities, we will use body length to get residuals for tail length and ear length
# First, let's make sure our body length data are normally distributed
hist(VertNetMetaData$bodylength_mm, breaks = 25)
lmBL <- lm(bodylength_mm~abslat, data=VertNetMetaData)
summary(lmBL)
plot(lmBL$residuals)
hist(lmBL$residuals)
plot(VertNetMetaData$bodylength_mm~VertNetMetaData$abslat)
abline(5,0, col="red") #sample points are in order (index)
abline(131,0, col="red")

# it's clear that any body length above 130mm is an outlier. like body mass, it's not as clear for shorter body lengths, but it seems like anything below 5mm is an outlier (and a really small mouse that is likely to be a juvenile)

# "offical" outlier test on full data to make sure that outliers I ID'd above are indeed outliers
out_BL_full<-boxplot.stats(VertNetMetaData$bodylength_mm)$out
out_BL_full
plot(VertNetMetaData$bodylength_mm)
abline(5,0, col="red") #sample points are in order (index)
abline(131,0, col="red")


# Let's see if these outliers are also outliers in the adult-only dataset
hist(AdultVertNet$bodylength_mm, breaks = 25)
lmBLadults <- lm(bodylength_mm~abslat, data=AdultVertNet)
summary(lmBLadults)
plot(lmBLadults$residuals)
hist(lmBLadults$residuals)
plot(AdultVertNet$bodylength_mm~AdultVertNet$abslat)
abline(5,0, col="red") #sample points are in order (index)
abline(131,0, col="red")
```
From the above data exploration (in both full and adult-only datasets), it is clear that any mouse with a body length above 130mm is an outlier. Moreover, any mouse with a body length below 5mm is an outlier. These data points will be removed from subsequent analyses. Overall, the remaining body lengths will be used to acquire residuals of tail length and ear length.


##### 3b. Plot raw data of tail length to find outliers
```{r all_data_tails, message=FALSE, fig.show='hide'}
#### check data to ensure they are normally distributed ####
hist(VertNetMetaData$taillength_mm, breaks = 25)
lmTL <- lm(taillength_mm~abslat, data=VertNetMetaData)
summary(lmTL)
plot(lmTL$residuals)
hist(lmTL$residuals, breaks = 25) # looks normally distributed!


#### check for outliers ####
plot(VertNetMetaData$taillength_mm~VertNetMetaData$abslat)
abline(25,0, col="red")
abline(120,0, col="red")

tempTL<-as.data.frame(lmTL$residuals)
tempTL<-tempTL[order(tempTL$`lmTL$residuals`),] # puts residuals in order from small->large
plot(tempTL)


# seems like tails shorter than 25mm and longer than 120mm are clear outliers

# Outlier test on full data
out_tail_full<-boxplot.stats(VertNetMetaData$taillength_mm)$out
out_tail_full
plot(VertNetMetaData$taillength_mm)
abline(25,0, col="red") #sample points are in order (index)
abline(120,0, col="red")


# Tail Length for adults only
hist(AdultVertNet$taillength_mm, breaks = 25)
lmTLadults <- lm(taillength_mm~abslat, data=AdultVertNet)
summary(lmTLadults)
plot(lmTLadults$residuals)
hist(lmTLadults$residuals)
plot(AdultVertNet$taillength_mm~AdultVertNet$abslat)
abline(25,0, col="red")
abline(120,0, col="red")

# any tail shorter than 25mm is a clear outlier. and no adult mouse has a tail length >120mm

# Outlier test on adult dataset
out_tail_adult<-boxplot.stats(AdultVertNet$taillength_mm)$out
out_tail_adult
plot(AdultVertNet$taillength_mm~AdultVertNet$abslat)
abline(25,0, col="red") #sample points are in order (index)
abline(120,0, col="red")

# Based on these outlier tests, any tail length less than 25 and greater than 120 are clear outliers


```

3b. Plot the data - Tail length and Allen's Rule
```{r plot_TailAllen, message = FALSE}
VertNetTail <- VertNetMetaData %>%
  filter(taillength_mm > 25, taillength_mm < 120) %>%
  filter(bodylength_mm > 5, bodylength_mm < 130)

### Get BL-corrected residuals of tail length
plot(VertNetTail$taillength_mm~VertNetTail$bodylength_mm)
lmTLBL <- lm(taillength_mm~bodylength_mm, data=VertNetTail)
summary(lmTLBL)
plot(lmTLBL$residuals)
hist(lmTLBL$residuals, breaks = 25)
resTLBL <- resid(lmTLBL) # save residuals so can plot them later
plot(cooks.distance(lmTLBL), pch = 16, col = "blue") # see if any weird outliers
cooksTLBL <- cooks.distance(lmTLBL)
# Plot the Cook's Distance using the traditional 4/n criterion
sample_size <- nrow(VertNetTail)
plot(cooksTLBL, pch="*", cex=2, main="Influential Obs by Cooks distance")  # plot cook's distance
abline(h = 4/sample_size, col="red")  # add cutoff line
text(x=1:length(cooksTLBL)+1, y=cooksTLBL, labels=ifelse(cooksTLBL>4/sample_size, names(cooksTLBL),""), col="red")  # add labels

VertNetAllen$Resids_TLxBL <- resid(lmAllen) # saves residuals to VertNetAllen dataset (the dataset used to create lm and residuals)

# Plot the data
Allen <-
  ggplot(data=VertNetAllen, aes(x = abslat, y = Resids_TLxBL)) +
  geom_jitter(aes(color = lifestage)) +
  geom_smooth(data=subset(VertNetAllen, lifestage == "adult"),
             aes(x = abslat, y = Resids_TLxBL, color=factor(lifestage)),
             method = "lm", se = FALSE) + # just draws a line for adults
  scale_color_manual(values=c(mycol, "black")) +
  scale_fill_manual(values=c(mycol, "black")) +
  theme_bw() + 
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
        axis.title.x = element_text(margin = margin(t = 25), size = 18, face = "bold", family = "Palatino"),
        axis.title.y = element_text(margin = margin(r = 23), size = 18, face = "bold", family = "Palatino"),
        axis.text.x = element_text(size = 15, face = "bold", color = "black", family = "Palatino"),
        axis.text.y = element_text(size = 15, face = "bold", color = "black", family = "Palatino")) +
  theme(legend.title = element_blank(),
        legend.position="none",
        legend.key.size = unit(1.5, "cm"),
        legend.text = element_text(size=10),
        legend.key = element_rect(fill = "transparent")) +
  theme(plot.title = element_text(size = 20, face = "bold", hjust = 0.5, family = "serif")) +
  labs(x = "Absolute Latitude", y = "Tail Length Residuals")
Allen + geom_smooth(method = "lm", se = FALSE, color = mycol) # draws a line for all lifestage data (both NA and adults)

# ensure it's the same plot
plot(VertNetAllen$abslat, resAllen)
```

3c. Create linear regression for Allen's Rule.
```{r TLstats_adults, message=FALSE}
lmAllenRes <- lm(resAllen~abslat, data=VertNetAllen)
summary(lmAllenRes)

VertNetAllenAdult <- VertNetAllen %>%
  filter(lifestage == "adult")

lmAllenAdult <- lm(taillength_mm~bodylength_mm, data=VertNetAllenAdult)
summary(lmAllenAdult)
resAllenAdult <- resid(lmAllenAdult)
plot(VertNetAllen$taillength_mm~VertNetAllen$bodylength_mm)
plot(cooks.distance(lmAllen), pch = 16, col = "blue") # see if any weird outliers
cooksdAdult <- cooks.distance(lmAllenAdult)
plot(lmAllen$residuals)
hist(lmAllen$residuals, breaks = 25)
# Plot the Cook's Distance using the traditional 4/n criterion
sample_size <- nrow(VertNetAllenAdult)
plot(cooksdAdult, pch="*", cex=2, main="Influential Obs by Cooks distance")  # plot cook's distance
abline(h = 4/sample_size, col="red")  # add cutoff line
text(x=1:length(cooksdAdult)+1, y=cooksd, labels=ifelse(cooksdAdult>4/sample_size, names(cooksdAdult),""), col="red")  # add labels

VertNetAllenAdult$Resids_TLxBL_adults <- resid(lmAllenAdult)
# ensure it's the same plot
plot(VertNetAllenAdult$abslat, resAllenAdult)

lmAllenAdultRes <- lm(resAllenAdult~abslat, data=VertNetAllenAdult)
summary(lmAllenAdultRes)

```

3d. Does it matter if residuals are created from body length or body weight?
```{r}
VertNetAllen2 <- VertNetMetaData %>%
  filter(taillength_mm > 30, taillength_mm < 120) %>% # tail length must be between 30-120mm
  filter(bodyweight_g < 35)


VertNetAllenAdult2 <- VertNetAllen2 %>%
  filter(lifestage == "adult")

#### To get BL-corrected residuals of tail length
lmAllen2 <- lm(taillength_mm~bodyweight_g, data=VertNetAllen2)
summary(lmAllen2)
resAllen2 <- resid(lmAllen2)
plot(VertNetAllen2$taillength_mm~VertNetAllen2$bodyweight_g)
plot(cooks.distance(lmAllen2), pch = 16, col = "blue") # see if any weird outliers
cooksd2 <- cooks.distance(lmAllen2)
plot(lmAllen2$residuals)
hist(lmAllen2$residuals, breaks = 25)
# Plot the Cook's Distance using the traditional 4/n criterion
sample_size <- nrow(VertNetAllen2)
plot(cooksd2, pch="*", cex=2, main="Influential Obs by Cooks distance")  # plot cook's distance
abline(h = 4/sample_size, col="red")  # add cutoff line
text(x=1:length(cooksd2)+1, y=cooksd, labels=ifelse(cooksd>4/sample_size, names(cooksd2),""), col="red")  # add labels

VertNetAllen2$Resids_TLxBW <- resid(lmAllen2) # saves residuals to VertNetAllen dataset (the dataset used to create lm and residuals)

# Plot the data
Allen2 <-
  ggplot(data=VertNetAllen2, aes(x = abslat, y = Resids_TLxBW)) +
  geom_jitter(aes(color = lifestage)) +
  geom_smooth(data=subset(VertNetAllen2, lifestage == "adult"),
             aes(x = abslat, y = Resids_TLxBW, color=factor(lifestage)),
             method = "lm", se = FALSE) + # just draws a line for adults
  scale_color_manual(values=c(mycol, "black")) +
  scale_fill_manual(values=c(mycol, "black")) +
  theme_bw() + 
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
        axis.title.x = element_text(margin = margin(t = 25), size = 15, face = "bold", family = "Palatino"),
        axis.title.y = element_text(margin = margin(r = 25), size = 15, face = "bold", family = "Palatino"),
        axis.text.x = element_text(size = 12, face = "bold", color = "black", family = "Palatino"),
        axis.text.y = element_text(size = 12, face = "bold", color = "black", family = "Palatino")) +
  theme(legend.title = element_blank(),
        legend.position="none",
        legend.key.size = unit(1.5, "cm"),
        legend.text = element_text(size=10),
        legend.key = element_rect(fill = "transparent")) +
  theme(plot.title = element_text(size = 20, face = "bold", hjust = 0.5, family = "serif")) +
  labs(x = "Absolute Latitude", y = "Tail Length Residuals") #+
  ggtitle("Tail Length ~ Body Weight")
Allen2 + geom_smooth(method = "lm", se = FALSE, color = mycol) # draws a line for all lifestage data (both NA and adults)

# ensure it's the same plot
plot(VertNetAllen2$abslat, resAllen2)

```


3e. Create linear regression for Allen's Rule (body weight).
```{r TLstats_adults, message=FALSE}
lmAllenRes2 <- lm(resAllen2~abslat, data=VertNetAllen2)
summary(lmAllenRes2)

VertNetAllenAdult2 <- VertNetAllen2 %>%
  filter(lifestage == "adult")

lmAllenAdult2 <- lm(taillength_mm~bodyweight_g, data=VertNetAllenAdult2)
summary(lmAllenAdult2)
resAllenAdult2 <- resid(lmAllenAdult2)
plot(VertNetAllenAdult2$taillength_mm~VertNetAllenAdult2$bodyweight_g)
plot(cooks.distance(lmAllenAdult2), pch = 16, col = "blue") # see if any weird outliers
cooksdAdult2 <- cooks.distance(lmAllenAdult2)
plot(lmAllenAdult2$residuals)
hist(lmAllenAdult2$residuals, breaks = 25)
# Plot the Cook's Distance using the traditional 4/n criterion
sample_size <- nrow(VertNetAllenAdult2)
plot(cooksdAdult2, pch="*", cex=2, main="Influential Obs by Cooks distance")  # plot cook's distance
abline(h = 4/sample_size, col="red")  # add cutoff line
text(x=1:length(cooksdAdult2)+1, y=cooksd, labels=ifelse(cooksdAdult2>4/sample_size, names(cooksdAdult2),""), col="red")  # add labels

VertNetAllenAdult2$Resids_TLxBW_adults <- resid(lmAllenAdult2)
# ensure it's the same plot
plot(VertNetAllenAdult2$abslat, resAllenAdult2)

lmAllenAdultRes2 <- lm(resAllenAdult2~abslat, data=VertNetAllenAdult2)
summary(lmAllenAdultRes2)

```


4. Explore the data of ear length - Allen's Rule

4a. Plot raw data to find outliers
```{r earlength, message=FALSE}
# All things ear length
hist(VertNetMetaData$earlength_mm, breaks = 25)
dotchart(VertNetMetaData$earlength_mm, color = VertNetMetaData$sex)
VertNetMetaData[order(VertNetMetaData$earlength_mm),] # put data in order from small->large TL
plot(VertNetMetaData$earlength_mm)
abline(4,0, col="red") #sample points are in order (index)
abline(40,0, col="red")
# clear(!) outlier is above 40 mm
```

4b. Plot the data - Ear length and Allen's Rule
```{r plot_Bergmann, message = FALSE}
VertNetEar <- VertNetMetaData %>%
  filter(earlength_mm < 40) %>%
  filter(bodylength_mm > 30, bodylength_mm < 120)

plot(VertNetEar$earlength_mm~VertNetEar$bodylength_mm)


#### To get BL-corrected residuals of ear length
lmEar <- lm(earlength_mm~bodylength_mm, data=VertNetEar)
summary(lmEar)
resEar <- resid(lmEar)
plot(VertNetEar$earlength_mm~VertNetEar$bodylength_mm)
plot(cooks.distance(lmEar), pch = 16, col = "blue") # see if any weird outliers
cooksdEar <- cooks.distance(lmEar)
plot(lmEar$residuals)
hist(lmEar$residuals, breaks = 25)
# Plot the Cook's Distance using the traditional 4/n criterion
sample_size <- nrow(VertNetEar)
plot(cooksdEar, pch="*", cex=2, main="Influential Obs by Cooks distance")  # plot cook's distance
abline(h = 4/sample_size, col="red")  # add cutoff line
text(x=1:length(cooksdEar)+1, y=cooksdEar, labels=ifelse(cooksdEar>4/sample_size, names(cooksdEar),""), col="red")  # add labels

VertNetEar$Resids_Ear_BL <- resid(lmEar) # saves residuals to VertNetAllen dataset (the dataset used to create lm and residuals)

# Plot the data
Ear <-
  ggplot(data=VertNetEar, aes(x = abslat, y = Resids_Ear_BL)) +
  geom_jitter(aes(color = lifestage)) +
  geom_smooth(data=subset(VertNetEar, lifestage == "adult"),
             aes(x = abslat, y = Resids_Ear_BL, color=factor(lifestage)),
             method = "lm", se = FALSE) + # just draws a line for adults
  scale_color_manual(values=c(mycol, "black")) +
  scale_fill_manual(values=c(mycol, "black")) +
  theme_bw() + 
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
        axis.title.x = element_text(margin = margin(t = 25), size = 18, face = "bold", family = "Palatino"),
        axis.title.y = element_text(margin = margin(r = 23), size = 18, face = "bold", family = "Palatino"),
        axis.text.x = element_text(size = 15, face = "bold", color = "black", family = "Palatino"),
        axis.text.y = element_text(size = 15, face = "bold", color = "black", family = "Palatino")) +
  theme(legend.title = element_blank(),
        legend.position="none",
        legend.key.size = unit(1.5, "cm"),
        legend.text = element_text(size=10),
        legend.key = element_rect(fill = "transparent")) +
  theme(plot.title = element_text(size = 20, face = "bold", hjust = 0.5, family = "serif")) +
  labs(x = "Absolute Latitude", y = "Ear Length Residuals") #+
  #ggtitle("Ear Length ~ Body Length")
Ear + geom_smooth(method = "lm", se = FALSE, color = mycol) # draws a line for all lifestage data (both NA and adults)

# ensure it's the same plot
plot(VertNetEar$abslat, resEar)
```

4c. Create linear regression for Ear length (Allen's Rule).
```{r TLstats_adults, message=FALSE}
lmEarRes <- lm(resEar~abslat, data=VertNetEar)
summary(lmEarRes)

VertNetEarAdult <- VertNetEar %>%
  filter(lifestage == "adult")

lmEarAdult <- lm(earlength_mm~bodylength_mm, data=VertNetEarAdult)
summary(lmEarAdult)
resEarAdult <- resid(lmEarAdult)
plot(VertNetEarAdult$earlength_mm~VertNetEarAdult$bodylength_mm)
plot(cooks.distance(lmAllen), pch = 16, col = "blue") # see if any weird outliers
cooksdAdult <- cooks.distance(lmAllenAdult)
plot(lmAllen$residuals)
hist(lmAllen$residuals, breaks = 25)
# Plot the Cook's Distance using the traditional 4/n criterion
sample_size <- nrow(VertNetAllenAdult)
plot(cooksdAdult, pch="*", cex=2, main="Influential Obs by Cooks distance")  # plot cook's distance
abline(h = 4/sample_size, col="red")  # add cutoff line
text(x=1:length(cooksdAdult)+1, y=cooksd, labels=ifelse(cooksdAdult>4/sample_size, names(cooksdAdult),""), col="red")  # add labels

VertNetEarAdult$Resids_Ear_BL_adults <- resid(lmEarAdult)
# ensure it's the same plot
plot(VertNetAllenAdult$abslat, resAllenAdult)

lmEarAdultRes <- lm(resEarAdult~abslat, data=VertNetEarAdult)
summary(lmEarAdultRes)

```